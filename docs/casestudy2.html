<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.555">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>International Statistics Conference 2024Case Study Poster Competition - Case Study 2</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">International Statistics Conference 2024<br>Case Study Poster Competition</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="./guidelines.html"> 
<span class="menu-text">Competition Guidelines</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./registration.html"> 
<span class="menu-text">Competition Registration</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./casestudy1.html"> 
<span class="menu-text">Case Study 1</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="./casestudy2.html" aria-current="page"> 
<span class="menu-text">Case Study 2</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./submissions.html"> 
<span class="menu-text">Submissions</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./announcements.html"> 
<span class="menu-text">Announcements</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#predicting-credit-risk-and-building-a-credit-risk-score-to-detect-fraud" id="toc-predicting-credit-risk-and-building-a-credit-risk-score-to-detect-fraud" class="nav-link active" data-scroll-target="#predicting-credit-risk-and-building-a-credit-risk-score-to-detect-fraud">Predicting Credit Risk and Building a Credit Risk Score to detect Fraud</a></li>
  <li><a href="#case-giving-organization" id="toc-case-giving-organization" class="nav-link" data-scroll-target="#case-giving-organization">Case giving organization</a></li>
  <li><a href="#introduction-to-the-case-study-2" id="toc-introduction-to-the-case-study-2" class="nav-link" data-scroll-target="#introduction-to-the-case-study-2">Introduction to the case study 2</a></li>
  <li><a href="#problem-statement-and-defining-the-objectives" id="toc-problem-statement-and-defining-the-objectives" class="nav-link" data-scroll-target="#problem-statement-and-defining-the-objectives">Problem Statement and Defining the Objectives</a></li>
  <li><a href="#dataset-overview" id="toc-dataset-overview" class="nav-link" data-scroll-target="#dataset-overview">Dataset Overview</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Case Study 2</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="predicting-credit-risk-and-building-a-credit-risk-score-to-detect-fraud" class="level1">
<h1>Predicting Credit Risk and Building a Credit Risk Score to detect Fraud</h1>
</section>
<section id="case-giving-organization" class="level1">
<h1>Case giving organization</h1>
<p>The name of the organization supplying the case is kept confidential.</p>
</section>
<section id="introduction-to-the-case-study-2" class="level1">
<h1>Introduction to the case study 2</h1>
<div style="text-align: justify;">
<p>The financial industry is built on lending. From mortgages to credit cards, personal loans to business financing, banks extend credit to customers to generate profit. However, lending carries several risks. Beyond traditional credit risks such as the possibility that borrowers may fail to repay their debts, financial institutions today face an equally concerning threat: fraudulent activity. Fraudulent behavior is when an individual’s exploit vulnerabilities in the lending system. This not only represents a risk of default but also a potential legal and financial exposure for the bank.</p>
<p>In the world of lending, a charge-off is a term that strikes fear into the hearts of financial institutions. When an account is “charged off,” it means that the bank or lender has determined that the borrower is highly unlikely to pay back their debt. As a result, the lender removes the debt from its balance sheet, recognizing it as a financial loss. However, just because an account is charged off doesn’t mean that the borrower is completely off the hook. The lender may still pursue collections or sell the debt to a collection agency.</p>
<p>In particular, accounts that become charged off, many customers display behaviors that suggest potential fraud. These customers intentionally apply for loans with no intention of repayment, a clear indication of fraud. Without a proactive method to detect such customers, they have the ability to engage in such activities with various banks. Given these complexities, financial institutions need robust tools to predict not just credit risk but also the likelihood of fraud. A charge-off is not merely a sign of financial distress but may also be an indicator of deliberate fraudulent activity. Identifying these signals early allows banks to prevent fraudulent losses, minimize risks, and ensure compliance with stringent regulatory frameworks.</p>
</div>
</section>
<section id="problem-statement-and-defining-the-objectives" class="level1">
<h1>Problem Statement and Defining the Objectives</h1>
<p><strong>Scenario: Your Role as a Data Scientist at a Leading Financial Institution</strong></p>
<div style="text-align: justify;">
<p>You are the lead data scientist at a major financial institution, responsible for managing consumer credit products such as credit cards, personal loans, and mortgages. Over the past few years, your institution has experienced a sharp increase in the number of charged-off accounts, particularly in the credit card and personal loan divisions. Senior management has raised alarms over the financial and reputational risks posed by these charge-offs, with a growing concern about fraudulent activity.</p>
<p>As part of your role, you have been tasked with building a sophisticated fraud detection and credit risk scoring model. The executive team needs a system that identifies fraudulent activity by identifying high risk customers. A high-risk customer with a high-risk credit score can indicate fraudulent activities as the customer can be creating a profile to get loans with the ultimate intention of defaulting. The current models, which rely heavily on traditional financial ratios and FICO scores, are insufficient for addressing the evolving challenges posed by fraudsters who are becoming increasingly adept at evading detection.</p>
<p>You are provided with a dataset containing customer records, each reflecting financial and behavioral data related to their credit history. Your task is to design a predictive model that assigns a risk score between 0 (low risk) and 1000 (high risk), and thereby detects potentially fraudulent activity among these high-risk customers. The score will be used by credit officers to guide their decision-making on whether to approve or deny credit to high-risk customers.</p>
<p>However, it should be noted that, in high-stakes domains like finance, especially when dealing with fraud detection and credit risk assessment, explainability is essential. While predictive models may achieve high accuracy, their decisions must be transparent and justifiable to both internal stakeholders (e.g., credit officers) and external regulatory bodies. Banks must be able to explain why a customer was flagged as high-risk or fraudulent to ensure fairness, avoid legal issues, and maintain customer trust. Explainability is essential for several reasons:</p>
<ol type="1">
<li><p>Regulatory Compliance: Financial institutions are required to comply with strict regulatory frameworks regarding risk assessments and decision-making. Black-box models, where the decision-making process is opaque, may not be acceptable to regulators. Your model needs to generate interpretable outputs, explaining how specific features (e.g., FICO score, delinquent accounts, payment methods) contributed to the decision.</p></li>
<li><p>Customer Trust and Fairness: In cases where customers are flagged as high-risk or fraudulent, banks must provide clear explanations to customers about why they were denied credit or flagged for further review. Ensuring transparency can protect banks from accusations of bias or discrimination.</p></li>
<li><p>Internal Decision-Making: Credit officers and fraud investigators rely on risk models to inform their decisions. However, beyond a simple risk score, they need to understand the factors driving the risk. Was the customer flagged because of their FICO score? Or was it their unusual submission pattern or the use of a high-risk payment method? Your model should provide actionable insights that allow the bank to take appropriate actions, such as investigating potential fraud cases more deeply or offering alternative repayment plans.</p></li>
</ol>
<p>Therefore, your task is not only to predict credit risk score but also to ensure that the model’s decisions are explainable. Each prediction should be traceable to key features, such as the customer’s FICO score, debt-to-income ratio, or the number of delinquent accounts. These factors should be presented clearly to both the bank’s management and the regulatory bodies. You will need to strike a balance between complexity (for better performance) and interpretability (for regulatory and business use).</p>
<p>As a summary, the objectives of this case study are as follows:</p>
<ul>
<li><p>Perform a comprehensive Exploratory Data Analysis (EDA) to understand the underlying patterns and investigate the key relationships between variables, particularly those related with fraudulent behavior and the likelihood of charge-off. Support your analysis with relevant literature on fraud detection and credit risk management.</p></li>
<li><p>Model Development: Build a machine learning model that predicts whether an account is likely to be charged off (a good indicator of fraudulent accounts) and generates a credit risk score between 0 and 1000 for each customer based on their predicted risk level. This score should be interpretable, with 0 representing low risk and 1000 representing high risk.</p></li>
</ul>
</div>
</section>
<section id="dataset-overview" class="level1">
<h1>Dataset Overview</h1>
<p>The dataset consists of 7000 observations, each representing an individual who applied for credit. It includes a combination of demographic, financial, and behavioral variables.</p>
<p>Description of the variables:</p>
<ol type="1">
<li><p><code>Account_open_date</code>: Date on which the account was opened.</p></li>
<li><p><code>Age</code>: Age of the customer.</p></li>
<li><p><code>Location</code>: Location where the customer is located.</p></li>
<li><p><code>Occupation</code>: Occupation of customer.</p></li>
<li><p><code>Income_level</code>: Income level of customer.</p></li>
<li><p><code>Fico_score</code>: Credit score created by the Fair Isacc Corporation (FICO), which is widely used by lenders to assess the creditworthiness of borrowers. It’s a three-digit number that typically ranges from 300 – 850, with higher scores indicating better credit risk.</p></li>
<li><p><code>Delinquency_status</code>: Indicates how late a customer is in making their required payments. Measured in number of days.</p></li>
<li><p><code>Number_of_credit_applications</code>: How many times a customer has applied for credit within a certain period.</p></li>
<li><p><code>Debt_to_income_ratio</code>: High Debt to Income ratios could indicate financial distress, which may correlate with fraud risk.</p></li>
<li><p><code>Payment_methods_high_risk</code>: High risk payment methods like cryptocurrencies.</p></li>
<li><p><code>Max_balance</code>: Highest account balance the customer has ever had in their account.</p></li>
<li><p><code>Avg_balance_last_12months</code>: Average account balance over the past year.</p></li>
<li><p><code>Number_of_delinquent_accounts</code>: Count of accounts that have missed one or more payments within a specified period.</p></li>
<li><p><code>Number_of_defaulted_accounts</code>: Count of accounts where the user has failed to meet the agreed–upon repayment terms for an extended period and has led to default.</p></li>
<li><p><code>Earliest_credit_account</code>: Date of the first credit account opened by a user.</p></li>
<li><p><code>Recent_trade_activity</code>: Date of the most recent transaction activities reported.</p></li>
<li><p><code>New_accounts_opened_last_12months</code>: Number of new accounts opened over the last year.</p></li>
<li><p><code>Multiple_applications_short_time_period</code>: Occurrence of a user submitting multiple credit applications within short period. This is a Boolean variable.</p></li>
</ol>
<p>True – user has submitted multiple credit applications, False – user hasn’t submitted multiple credit applications</p>
<ol start="19" type="1">
<li><code>Unusual_submission_pattern</code>: Identification of irregular behavior in the transactions by a user. This is a Boolean variable.</li>
</ol>
<p>True – User has exhibited irregular behavior, False - User hasn’t exhibited irregular behavior</p>
<ol start="20" type="1">
<li><code>Applications_submitted_during_odd_hours</code>: Whether the transactions were done outside of standard business hours (late night, early morning). This is a Boolean variable.</li>
</ol>
<p>True – User done the transaction during odd hours, False – User done the transaction during standard hours</p>
<ol start="21" type="1">
<li><code>Watchlist_blacklist_flag</code>: Whether the user appears on a predefined list that are considered high risk for activities. This is a Boolean variable.</li>
</ol>
<p>True – user is on the predefined list, False – user isn’t on the predefined list</p>
<ol start="22" type="1">
<li><code>Public_records_flag</code>: Whether the user has any entries in public records that may affect their creditworthiness or financial stability. This is a Boolean variable. True – user has one or more public records, False – user doesn’t have any public records</li>
</ol>
<p><strong>Target Variable:</strong></p>
<ul>
<li>Charge Off Status: This is a boolean variable (True/False). True indicates that indicates that the account has been charged off. This means that the customer has failed to meet their repayment obligations for an extended period (typically 120 to 180 days, depending on the type of credit product) False indicates that the account is still active and has not been charged off. This means that the customer is either current with their payments or has not yet reached the charge-off threshold.</li>
</ul>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/thiyangt\.github\.io\/ISC2024\.case\.study\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>